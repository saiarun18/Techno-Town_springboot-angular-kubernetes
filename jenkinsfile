pipeline {

    environment{
        VERSION = "${env.BUILD_ID}"
    }

    agent {
                docker {
                image 'maven'
                args '-v $HOME/.m2:/root/.m2'
                }
            }
    stages {
        stage('Download SC') {
            steps {
                git 'https://github.com/saiarun18/Techno-Town_springboot-angular-kubernetes.git'
            }
        }
        stage('Quality Gate Status Check'){
               
                  steps{
                      script{
                      withSonarQubeEnv('sonarserver') { 
                            sh 'mvn clean package sonar:sonar'
                       }
                      timeout(time: 1, unit: 'HOURS') {
                      def qg = waitForQualityGate()
                      if (qg.status != 'OK') {
                           error "Pipeline aborted due to quality gate failure: ${qg.status}"
                      }
                    }
		    sh "mvn clean install"
                  }
                }  
              }
            stage{
                steps{
                    script{
                        def dockerHome = tool 'myDocker'
                        env.PATH = "${dockerHome}/bin:${env.PATH}"
                    }
                }
            }  
            stage('Docker Image & Nexus Push'){
                steps{
                    script{
                        withCredentials([string(credentialsId: 'docker-pass', variable: 'nexus_pwd')]) {
                        sh '''
                           docker build -t 34.70.173.223:8083/spring:${VERSION} .
                           docker login -u admin -p $nexus_pwd 34.70.173.223:8083
                           docker push 34.70.173.223:8083/spring:${VERSION}
                           docker rmi 34.70.173.223:8083/spring:${VERSION}
                        '''
                        }
                        
                    }
                }
            }   
    }
}